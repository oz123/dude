#!/usr/bin/env python3

"""
A tiny helper script to help figure which package needs to be built next

run this from the top of the overlay
"""
import os
import re
import shutil

VERSION = "1.26"

match_p_v = re.compile("(?P<group>\w.*?)/(?P<name>[\w.-]*)/(?P<ebuild>[\w.-]*)-(?P<version>1.*)\.ebuild")


def list_ebuilds(package):
    for root, dirs, files in os.walk(package):
        for f in files:
            if f.endswith('ebuild'):
                yield os.path.join(root, f)

with open("scripts/files/package-lists/package-list-9999-topological") as plist:  # noqa
    packages = list(map(lambda x: x.strip(), plist.readlines()))


for package in packages:
    rgx = "%s/%s-%s.*.ebuild" % (package, package.split("/")[-1], VERSION)
    ebuild_updated = False
    ebuilds = sorted(list_ebuilds(package))
    for ebuild in ebuilds:
        if re.search(rgx, ebuild):
            ebuild_updated = True
            break
    if not ebuild_updated:
        latest = ebuilds[-2] if "9999" in ebuilds[-1] else ebuilds[-1]
        m = match_p_v.search(latest)
        name = f"{m.groupdict()['group']}/{m.groupdict()['name']}/{m.groupdict()['ebuild']}-{VERSION}.0.ebuild"
        shutil.copy(latest, name) 
        print("Next package to work on ... {}".format(name))
        break
        
        
